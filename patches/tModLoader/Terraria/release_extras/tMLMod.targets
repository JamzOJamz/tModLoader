<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<!-- legacy property -->
		<TerrariaSteamPath>$(MSBuildThisFileDirectory)</TerrariaSteamPath>
		<tMLSteamPath>$(MSBuildThisFileDirectory)</tMLSteamPath>
		<tMLLibraryPath>$(tMLSteamPath)Libraries</tMLLibraryPath>
		<tMLName>tModLoader</tMLName>
		<tMLPath>$(tMLName).dll</tMLPath>
		<tMLServerPath>$(tMLPath) -server</tMLServerPath>
		<!-- TML stable version define placeholder -->
	</PropertyGroup>
	<ItemGroup>
		<AdditionalFiles Include="**/*.hjson" />
		<AdditionalFiles Include="**/*.txt" />
		<AdditionalFiles Include="**/*.png" />
		<Reference Include="$(tMLSteamPath)$(tMLPath)" />
		<Reference Include="$(tMLLibraryPath)/**/*.dll" />
		<Reference Remove="$(tMLLibraryPath)/Native/**" />
		<Reference Remove="$(tMLLibraryPath)/**/runtime*/**" />
		<Reference Remove="$(tMLLibraryPath)/**/*.resources.dll" />
	</ItemGroup>

	<ItemDefinitionGroup>
		<ModReference>
			<Visible>false</Visible>
		</ModReference>
	</ItemDefinitionGroup>
	<Target Name="IncludeModReferences" BeforeTargets="BeforeResolveReferences">
		<Message Text="Adding %(ModReference.Identity) as a reference" />

		<ItemGroup>
			<Reference Include="%(ModReference.Identity)" Condition="'%(ModReference.ProjectPath)'=='' AND '%(ModReference.HintPath)'!=''">
				<HintPath>%(ModReference.HintPath)</HintPath>
			</Reference>
		</ItemGroup>

		<ItemGroup>
			<ProjectReference Include="%(ModReference.ProjectPath)" Condition="'%(ModReference.ProjectPath)'!=''" Private="true" />
		</ItemGroup>
	</Target>

	<UsingTask TaskName="PackageModFile" AssemblyFile="$(tMLLibraryPath)/tModLoader.BuildTools/1.0.0/tModLoader.BuildTools.dll" />
	<Target Name="Package" AfterTargets="Build">
		<Message Text="Packaging mod..." />

		<Message Text="Convert mod properties into item group" />
		<ItemGroup>
			<ModProperty Include="Version" Value="$(Version)" Condition="$(Version) != ''" />
			<ModProperty Include="DisplayName" Value="$(DisplayName)" Condition="$(DisplayName) != ''" />
			<ModProperty Include="Author" Value="$(Author)" Condition="$(Author) != ''" />
			<ModProperty Include="Homepage" Value="$(Homepage)" Condition="$(Homepage) != ''" />
			<ModProperty Include="HideResources" Value="$(HideResources)" Condition="$(HideResources) != ''" />
			<ModProperty Include="IncludeSource" Value="$(IncludeSource)" Condition="$(IncludeSource) != ''" />
			<ModProperty Include="BuildIgnore" Value="$(BuildIgnore)" Condition="$(BuildIgnore) != ''" />
			<ModProperty Include="Side" Value="$(Side)" Condition="$(Side) != ''" />
			<ModProperty Include="SortBefore" Value="$(SortBefore)" Condition="$(SortBefore) != ''" />
			<ModProperty Include="SortAfter" Value="$(SortAfter)" Condition="$(SortAfter) != ''" />
			<ModProperty Include="PlayableOnPreview" Value="$(PlayableOnPreview)" Condition="$(PlayableOnPreview) != ''" />
			<ModProperty Include="TranslationMod" Value="$(TranslationMod)" Condition="$(TranslationMod) != ''" />
		</ItemGroup>

		<GetAssemblyIdentity AssemblyFiles="$(tMLSteamPath)$(tMLPath)">
			<Output TaskParameter="Assemblies" ItemName="TmlAssemblyIdentity" />
		</GetAssemblyIdentity>
		
		<PropertyGroup>
			<!-- Use default values in case they have not been provided -->
			<TmlVersion Condition="$(TmlVersion) == '' AND TmlAssemblyIdentity!=''">%(TmlAssemblyIdentity.Version)</TmlVersion>
			<TmlVersion Condition="$(TmlVersion) == '' AND TmlAssemblyIdentity==''">1.4</TmlVersion>
		</PropertyGroup>

		<PackageModFile
				PackageReferences="@(PackageReference)"
				ProjectReferences="@(_ResolvedProjectReferencePaths)"
				ModReferences="@(ModReference)"
				ReferencePaths="@(ReferencePath)"
				ProjectDirectory="$(MSBuildProjectDirectory)"
				OutputPath="$(OutputPath)"
				AssemblyName="$(AssemblyName)"
				TmlVersion="$(TmlVersion)"
				TmlDllPath="$(tMLSteamPath)$(tMLPath)"
				OutputTmodPath="$(OutputTmodPath)"
				ModProperties="@(ModProperty)" >
		</PackageModFile>
	</Target>
</Project>