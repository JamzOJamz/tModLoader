<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<!-- legacy property -->
		<TerrariaSteamPath>$(MSBuildThisFileDirectory)</TerrariaSteamPath>
		<tMLSteamPath>$(MSBuildThisFileDirectory)</tMLSteamPath>
		<tMLLibraryPath>$(tMLSteamPath)Libraries</tMLLibraryPath>
		<tMLName>tModLoader</tMLName>
		<tMLPath>$(tMLName).dll</tMLPath>
		<tMLServerPath>$(tMLPath) -server</tMLServerPath>
		<!-- TML stable version define placeholder -->
	</PropertyGroup>
	<ItemGroup>
		<Reference Include="$(tMLSteamPath)$(tMLPath)" />
		<Reference Include="$(tMLLibraryPath)/**/*.dll" />
		<Reference Remove="$(tMLLibraryPath)/Native/**" />
		<Reference Remove="$(tMLLibraryPath)/**/runtime*/**" />
		<Reference Remove="$(tMLLibraryPath)/**/*.resources.dll" />
	</ItemGroup>

	<ItemDefinitionGroup>
		<ModReference>
			<Visible>false</Visible>
		</ModReference>
	</ItemDefinitionGroup>
	<Target Name="IncludeModReferences" BeforeTargets="ResolveAssemblyReferences">
		<Message Text="Adding %(ModReference.Identity) as a reference" />
		<ItemGroup>
			<Reference Include="%(ModReference.Identity)">
				<HintPath Condition="%(ModReference.HintPath) != ''">%(ModReference.HintPath)</HintPath>
			</Reference>
		</ItemGroup>
	</Target>

	<UsingTask TaskName="PackageModFile" AssemblyFile="$(tMLLibraryPath)/tModLoader.BuildTools/1.0.0/tModLoader.BuildTools.dll" />
	<Target Name="Package" AfterTargets="Build">
		<Message Text="Packaging mod..." />

		<Message Text="Convert mod properties into item group" />
		<ItemGroup>
			<ModProperty Include="ModVersion" Value="$(ModVersion)" />
			<ModProperty Include="DisplayName" Value="$(DisplayName)" />
			<ModProperty Include="Author" Value="$(Author)" />
			<ModProperty Include="Homepage" Value="$(Homepage)" />
			<ModProperty Include="HideCode" Value="$(HideCode)" />
			<ModProperty Include="HideResources" Value="$(HideResources)" />
			<ModProperty Include="IncludeSource" Value="$(IncludeSource)" />
			<ModProperty Include="IncludePDB" Value="$(IncludePDB)" />
			<ModProperty Include="BuildIgnore" Value="$(BuildIgnore)" />
			<ModProperty Include="Side" Value="$(ModSide)" />
			<ModProperty Include="SortBefore" Value="$(SortBefore)" />
			<ModProperty Include="SortAfter" Value="$(SortAfter)" />
		</ItemGroup>

		<Warning
				Text="OutputTmodPath should be set to the location of the file to be written. If you are using 'dotnet build', add '/p:OutputTmodPath=path/to/file' after the command."
				Condition="$(OutputTmodPath) == ''" />

		<Warning
				Text="TmlVersion should be set to the version of TML this mod is being built for. If you are using 'dotnet build', add '/p:TmlVersion=0.1.2.3' after the command."
				Condition="$(TmlVersion) == ''" />

		<PropertyGroup>
			<!-- Use default values in case they have not been provided -->
			<OutputTmodPath Condition="$(OutputTmodPath) == ''">$(OutputPath)/$(AssemblyName).tmod</OutputTmodPath>
			<TmlVersion Condition="$(TmlVersion) == ''">1.4</TmlVersion>
		</PropertyGroup>

		<PackageModFile
				PackageReferences="@(PackageReference)"
				ModReferences="@(ModReference)"
				ReferencePaths="@(ReferencePath)"
				ProjectDirectory="$(MSBuildProjectDirectory)"
				OutputPath="$(OutputPath)"
				AssemblyName="$(AssemblyName)"
				TmlVersion="$(TmlVersion)"
				OutputTmodPath="$(OutputTmodPath)"
				ModProperties="@(ModProperty)" >
		</PackageModFile>
	</Target>
</Project>